<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ToplansÄ±n â€¢ Hesap Ä°ÅŸlemi</title>
  <style>
    :root{
      --bg:#081411;--card:#0c1713;--muted:#9ccdb9;--ok:#14e59b;--err:#ff6b6b;--ink:#e6fff4;
      --emerald:#10b981;--emerald-2:#059669;--stroke:rgba(34,197,94,.18)
    }
    @media (prefers-color-scheme:light){
      :root{--bg:#f3f7f5;--card:#ffffff;--muted:#3b5a4b;--ink:#0c1b14;--stroke:#d9efe5}
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;display:grid;place-items:center;min-height:100%;
      background:radial-gradient(1100px 400px at 50% -10%, rgba(16,185,129,.12), transparent 60%), var(--bg);
      color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif
    }
    .card{
      width:min(640px,92vw);background:var(--card);border:1px solid var(--stroke);
      border-radius:18px;padding:28px 28px 24px;box-shadow:0 24px 70px rgba(0,0,0,.45)
    }
    .hdr{display:flex;align-items:center;gap:14px;margin-bottom:12px}
    .logo{height:28px}
    .badge{
      margin-left:auto;display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.18);
      background:linear-gradient(135deg,#34d399 0%,#10b981 60%,#22c55e 100%);
      color:#052016;font-weight:900;font-size:12px;letter-spacing:.3px
    }
    h1{margin:6px 0 4px;font-size:22px}
    .muted{color:var(--muted)}
    .state-ok{color:var(--ok)} .state-err{color:var(--err)}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      margin-top:18px;background:linear-gradient(135deg,var(--emerald-2),var(--emerald));
      color:#04160f;padding:12px 18px;border-radius:12px;font-weight:900;text-decoration:none;border:1px solid rgba(255,255,255,.22)
    }
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row .btn{flex:1}

    .field{margin:14px 0}
    .field label{display:block;margin:0 0 6px;font-weight:800;font-size:14px}
    .field input{
      width:100%;padding:12px;border-radius:12px;border:1px solid var(--stroke);background:transparent;color:inherit;outline:none
    }
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .hide{display:none!important}
  </style>
</head>
<body>
  <div class="card">
    <div class="hdr">
      <img class="logo" src="/logo.png" alt="ToplansÄ±n">
      <div class="badge"><span>âš½</span> ToplansÄ±n</div>
    </div>

    <h1 id="title">Ä°ÅŸlem yapÄ±lÄ±yorâ€¦</h1>
    <p id="desc" class="muted">LÃ¼tfen bekleyin.</p>

    <!-- BaÅŸarÄ± butonu -->
    <a id="cta" class="btn hide" href="/">Uygulamaya DÃ¶n</a>

    <!-- Åžifre sÄ±fÄ±rlama -->
    <form id="resetForm" class="hide" novalidate>
      <div class="field">
        <label for="pw1">Yeni ÅŸifre</label>
        <input id="pw1" name="pw1" type="password" autocomplete="new-password" required />
        <div class="hint">En az 6 karakter ve <b>en az 1 rakam</b> iÃ§ermeli.</div>
      </div>
      <div class="field">
        <label for="pw2">Yeni ÅŸifre (tekrar)</label>
        <input id="pw2" name="pw2" type="password" autocomplete="new-password" required />
      </div>
      <div class="row">
        <button id="submitBtn" type="submit" class="btn">Åžifreyi Kaydet</button>
        <a id="cancelBtn" class="btn" href="/">VazgeÃ§</a>
      </div>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, applyActionCode, checkActionCode,
      verifyPasswordResetCode, confirmPasswordReset
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // ðŸ”§ Web config (kendi projenden birebir kopyala)
    const firebaseConfig = {
      apiKey: "AIzaSyCdwm1oNvZ_9R306ukmd_M2_n7iCudRcQ4",
      authDomain: "toplansin-e4363.firebaseapp.com",
      projectId: "toplansin-e4363",
      storageBucket: "toplansin-e4363.firebasestorage.app",
      messagingSenderId: "450679317964",
      appId: "1:450679317964:web:08de0d07bb040cf848e969",
      measurementId: "G-CVPG2R0XGB"
    };

    initializeApp(firebaseConfig);
    const auth = getAuth();

    const $ = (id)=>document.getElementById(id);
    const set = (id, html)=>{ $(id).innerHTML = html; };
    const show = (id)=>$(id).classList.remove("hide");
    const hide = (id)=>$(id).classList.add("hide");

    const qp = new URLSearchParams(location.search);
    const mode = qp.get("mode");
    const oobCode = qp.get("oobCode");
    const continueUrl = qp.get("continueUrl") || "/";

    function fail(title, msg){
      set("title", title);
      set("desc", msg);
      $("desc").className = "state-err";
      hide("resetForm"); show("cta");
    }

    async function handleVerifyEmail(){
      if (!oobCode) return fail("GeÃ§ersiz baÄŸlantÄ±", "Kod (oobCode) bulunamadÄ±.");
      try{
        await checkActionCode(auth, oobCode);
        await applyActionCode(auth, oobCode);
        set("title","E-posta doÄŸrulandÄ± ðŸŽ‰");
        set("desc","HesabÄ±n baÅŸarÄ±yla aktifleÅŸtirildi.");
        $("desc").className = "state-ok";
        const cta = $("cta"); cta.href = continueUrl; show("cta");
        // Otomatik yÃ¶nlendirme istersen: setTimeout(()=>location.replace(continueUrl), 1200);
      }catch(e){
        console.error(e);
        fail("DoÄŸrulama baÅŸarÄ±sÄ±z", "BaÄŸlantÄ± sÃ¼resi dolmuÅŸ veya daha Ã¶nce kullanÄ±lmÄ±ÅŸ olabilir. LÃ¼tfen yeni bir doÄŸrulama isteyin.");
      }
    }

    async function handleResetPassword(){
      if (!oobCode) return fail("GeÃ§ersiz baÄŸlantÄ±", "Kod (oobCode) bulunamadÄ±.");
      try{
        await verifyPasswordResetCode(auth, oobCode);
        set("title","Yeni ÅŸifreni belirle");
        set("desc","AÅŸaÄŸÄ±dan gÃ¼Ã§lÃ¼ bir ÅŸifre oluÅŸtur.");
        $("desc").className = "muted";
        show("resetForm");
      }catch(e){
        console.error(e);
        fail("Kod geÃ§ersiz", "BaÄŸlantÄ± sÃ¼resi dolmuÅŸ veya zaten kullanÄ±lmÄ±ÅŸ olabilir. LÃ¼tfen yeni bir sÄ±fÄ±rlama isteyin.");
      }
    }

    // âœ“ Åžifre politikasÄ±: min 6, en az 1 rakam
    function validPassword(p){ return /^(?=.*\d).{6,}$/.test(p); }

    $("resetForm").addEventListener("submit", async (ev)=>{
      ev.preventDefault();
      const p1 = $("pw1").value.trim();
      const p2 = $("pw2").value.trim();
      if (!validPassword(p1)) return alert("Åžifre en az 6 karakter olmalÄ± ve en az 1 rakam iÃ§ermeli.");
      if (p1 !== p2) return alert("Åžifreler eÅŸleÅŸmiyor.");
      $("submitBtn").disabled = true;
      try{
        await confirmPasswordReset(auth, oobCode, p1);
        set("title","Åžifre gÃ¼ncellendi âœ…");
        set("desc","Yeni ÅŸifrenle giriÅŸ yapabilirsin."); $("desc").className="state-ok";
        hide("resetForm"); const cta=$("cta"); cta.href=continueUrl; cta.textContent="Uygulamaya DÃ¶n"; show("cta");
      }catch(e){
        console.error(e);
        alert("Åžifre gÃ¼ncellenemedi. LÃ¼tfen farklÄ± bir ÅŸifre deneyin.");
        $("submitBtn").disabled = false;
      }
    });

    (async()=>{
      if (mode === "verifyEmail") await handleVerifyEmail();
      else if (mode === "resetPassword") await handleResetPassword();
      else fail("GeÃ§ersiz istek","mode parametresi eksik veya desteklenmiyor.");
    })();
  </script>
</body>
</html>
